description: >
  Publish a helm chart

parameters:
  chart-repo:
    type: string
    description: Repository for helm chart
  chart-org:
    type: string
    description: Organization for helm chart repo

steps:
  - run:
      name: Publish
      command: |
        CHART_REPO="<<parameters.chart-repo>>"
        CHART_ORG="<<parameters.chart-org>>"

        ## Package with helm and create helm chart release

        helm package . --destination .deploy
        cr upload -o $CHART_ORG -r $CHART_REPO -p .deploy

        ## Publish to helm chart repo by cloning down with personal access token

        cd ..
        git clone https://github.com/$CHART_ORG/$CHART_REPO charts
        cd charts
        git remote rm origin
        git remote add origin "https://${GIT_USER}:${CR_TOKEN}@github.com/${CHART_ORG}/${CHART_REPO}.git"
        git checkout gh-pages
        cr index -i index.yaml -p .deploy -o $CHART_ORG -r $CHART_REPO --charts-repo https://github.com/$CHART_ORG/$CHART_REPO
        git add index.yaml
        git commit -m "release new version [ci skip]"
        git push
